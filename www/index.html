<!DOCTYPE html>
<html>
<head>
    <title>Forms</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
    <link rel="stylesheet" href="css/ratchet.css"/>
    <link rel="stylesheet" href="css/ratchet-theme-android.css"/>
    <link rel="stylesheet" href="css/styles.css"/>
</head>

<body>

<div id="content"></div>

<script src="js/js-external/jquery.min.js"></script>
<script src="js/js-external/underscore-min.js"></script>
<script src="js/js-external/backbone-min.js"></script>
<script src="js/forcetk.mobilesdk.js"></script>

<!-- Local Testing -/->
<script src="js/forcetk.ui.js"></script>
<script src="js/MockCordova.js"></script>
<script src="js/cordova.force.js"></script>
<script src="js/MockSmartStore.js"></script>
<!-- End Local Testing -->

<!-- Container -->
<script src="cordova.js"></script>
<!-- End Container -->

<script src="js/smartsync.js"></script>
<script src="js/js-external/fastclick.js"></script>
<script src="js/js-external/stackrouter.js"></script>
<script src="js/js-external/auth.js"></script>



<!-- --------------------------------------- Search page template ------------------------------------------------- -->
<script id="search-page" type="text/template">
    <header class="bar bar-nav">
        <h1 class="title">Select Location of Incident</h1>
    </header>
    <footer class="bar bar-footer">
        <span id="offlineStatus"></span>
        <a class="btn btn-nav pull-right logoutUser">Logout</a>
        <a class="btn btn-nav pull-right switchUser">Switch</a>
        <a class="btn btn-nav pull-right inspectSmartstore">Db</a>
    </footer>

    <div class="bar bar-standard bar-header-secondary">
        <input type="search" class="search-key" placeholder="Search"/>
    </div>

    <div class="content">
        <ul class="table-view"></ul>
    </div>
</script>

<!-- --------------------------------------- Online/Offline Toggler Template -------------------------------------- -->

<script id="offline-toggler" type="text/template">
    <a class="btn <%= isOnline ? 'btn-positive' : 'btn-negative' %>"><%= (isOnline ? "Online" : "Offline") %></a>
</script>

<!-- --------------------------------------- Sync Page Template --------------------------------------------------- -->

<script id="sync-page" type="text/template">
    <header class="bar bar-nav">
        <a class="btn pull-left back">Back</a>
        <h1 class="title">Sync</h1>
    </header>

    <footer class="bar bar-footer">
        <span class="btn btn-positive">Online</span>
    </footer>

    <div class="bar bar-standard bar-header-secondary">
        <a class="btn btn-block sync">Process <%= countLocallyModified %> records</a>
    </div>

    <div class="content">
        <ul class="table-view"></ul>
    </div>
</script>

<!-- --------------------------------------- Account list item Template ------------------------------------------ -->
<script id="form-list-item" type="text/template">
    <a href="#edit/forms/<%= Id %>/false">
        <div>
            <span class="important"><%= Form_Group__c %></span>
            <br/><%= LastModifiedBy.Name %>
            <br/><span class="not-important"><%= Id %></span>
            <% if (__sync_failed__) { %>
            <span class="pull-right badge badge-negative">Failed to sync</span>
            <% } else if (__local__) { %>
            <span class="pull-right badge badge-primary">Locally<%= (__locally_created__ ? " created" : "") + (__locally_updated__ ? " updated" : "") + (__locally_deleted__ ? " deleted" : "") %></span>
            <% } else { %>
            <span class="pull-right badge badge-positive">Cached</span>
            <% } %>
        </div>
    </a>
</script>

<script id="location-list-item" type="text/template">
    <div>
        <a href="#add/form/<%= Id %>/false">
            <span class="important"><%= Location_ID__c.split('2015')[0] %></span>
            <br/><span class="not-important"><%= Id %></span>
            <% if (__sync_failed__) { %>
            <span class="pull-right badge badge-negative">Failed to sync</span>
            <% } else { %>
            <span class="pull-right badge badge-positive">Cached</span>
            <% } %>
        </a>
    </div>
</script>

<!-- --------------------------------------- Add/edit account page template -------------------------------------- -->
<script id="edit-form-page" type="text/template">
    <header class="bar bar-nav">
        <a class="btn btn-nav pull-left back">Back</a>
        <a class="btn btn-nav pull-right btn-negative toggleDelete">Delete</a>
        <h1 class="title"><%= action %> Form</h1>
    </header>

    <footer class="bar bar-footer">
        <span id="offlineStatusPage"></span>
    </footer>

    <div class="content">
        <div class="content-padded">

            <!--
                  <% if (__local__) { %>
                  <span class="badge badge-primary">Locally<%= (__locally_created__ ? " created" : "") + (__locally_updated__ ? " updated" : "") + (__locally_deleted__ ? " deleted" : "") %></span><br/><br/>
                  <% } %>
            -->

            <div class="input-group">
                <!-- TODO: add other incident info -->
                <div class="input-row" id="formInc__c">
                    <label>Time of Incident</label>
                    <input style="border-left: 1px solid black; padding:0px" type="datetime-local" name="Inc__c" value="<%= Inc__c %>" />
                    <span class="error" id="formInc__cError" />
                </div>
                <div class="input-row" id="formConsequence__c">
                    <label style="width:35%; padding-left: 6px; padding-right: 6px">Consequence</label>
                    <input style="border-left: 1px solid black; height:100%; width:65%" list="Consequence__c" name="Consequence__c"  value="<%= Consequence__c %>">
                    <datalist id="Consequence__c">
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                        <option value="Minimal">Minimal</option>
                        <option value="Ergonomic">Ergonomic</option>
                    </datalist>
                    <span class="error" id="formConsequence__cError" />
                </div>
                <div class="input-row" id="formIncident_Description__c">
                    <label>Description of Incident</label>
                    <input style="border-left: 1px solid black" type="text" name="Incident_Description__c" value="<%= Incident_Description__c %>" />
                    <span class="error" id="formIncident_Description__cError" />
                </div>
                <% if (LastModifiedDate) { %>
                <div class="input-row">
                    <label>Last Modified</label>
                    <input style="border-left: 1px solid black" type="text" value="<%= LastModifiedBy.Name + ' on ' + LastModifiedDate %>" readonly />
                </div>
                <% } %>
            </div>
        </div>
        <div class="content-padded">
            <a class="btn btn-primary save">Save</a>
            <a class="btn btn-positive merge">Merge</a>
            <a class="btn btn-negative overwrite">Overwrite</a>
        </div>
    </div>
</script>

<script>

    var formatDateTime = function (datetime) {
        return datetime + ':0.0000Z';
    };

    var currentDateTime = function () {
        var today = new Date();
        return today.getFullYear() + '-' +  (today.getMonth() + 1) + '-' + today.getDate() + 'T' + today.getHours() + ':' + today.getMinutes() + ':' + today.getSeconds() + '.000Z';
    };

    // -------------------------------------------------- The Models --------------------------------------------------- //
    // The Activity Form Model
    app.models.ActivityForm = Force.SObject.extend({
        sobjectType: "Activity_Form__c",
        fieldlist: function(method) {
            return method == "read"
                    ? ["Id", "RecordTypeId", "Form_Group__c", "Consequence__c", "Job__c", "Task__c", "Location__c", "Incident_Date_Time__c", "Inc__c", "Incident_Description__c", "Equipment_in_use__c", "Specific_Job_Type__c", "LastModifiedBy.Name", "LastModifiedDate"]
                    : ["Id", "RecordTypeId", "Form_Group__c", "Consequence__c", "Job__c", "Task__c", "Location__c", "Incident_Date_Time__c", "Inc__c", "Incident_Description__c", "Equipment_in_use__c", "Specific_Job_Type__c"];
        },
        cache: function() { return app.cache;},
        cacheForOriginals: function() { return app.cacheForOriginals;},
        cacheMode: function(method) {
            if (!app.offlineTracker.get("isOnline")) {
                return Force.CACHE_MODE.CACHE_ONLY;
            }
            else {
                return (method == "read" ? Force.CACHE_MODE.CACHE_FIRST : Force.CACHE_MODE.SERVER_FIRST);
            }
        }
    });

    app.models.Location = Force.SObject.extend({
        sobjectType: "Location__c",
        fieldlist: ["Id", "Location_ID__c"],
        cache: function() { return app.locationCache; },
        cacheMode: function(method) {
            if (!app.offlineTracker.get("isOnline")) {
                return Force.CACHE_MODE.CACHE_ONLY;
            } else {
                return Force.CACHE_MODE.CACHE_FIRST;
            }
        }
    });

    // The Activity Form Collection Model
    app.models.ActivityFormCollection = Force.SObjectCollection.extend({
        model: app.models.ActivityForm,
        fieldlist: ["Id", "RecordTypeId", "Form_Group__c", "Consequence__c", "Job__c", "Task__c", "Location__c", "Incident_Date_Time__c", "Inc__c", "Incident_Description__c", "Equipment_in_use__c", "Specific_Job_Type__c", "LastModifiedBy.Name", "LastModifiedDate"],
        cache: function() { return app.cache},
        cacheForOriginals: function() { return app.cacheForOriginals;},

        getCriteria: function() {
            return this.key;
        },

        setCriteria: function(key) {
            this.key = key;
        },

        config: function() {
            // Offline: do a cache query
            if (!app.offlineTracker.get("isOnline")) {
                // Not using like query because it does a case-sensitive sort
                return {type:"cache", cacheQuery:{queryType:"smart", smartSql:"SELECT {activity_form__c:_soup} FROM {activity_form__c} WHERE {activity_form__c:Form_Group__c} LIKE '" + (this.key == null ? "" : this.key) + "%' ORDER BY LOWER({activity_form_c:Form_Group__c})", pageSize:25}};
            }
            // Online
            else {
                // First time: do a full query
                if (this.key == null) {
                    return {type:"soql", query: "SELECT " + this.fieldlist.join(",") + " FROM Activity_Form__c ORDER BY Form_Group__c"};
                }
                // Other times: do a SOQL query
                else {
                    return {type:"soql", query: "SELECT " + this.fieldlist.join(",") + " FROM Activity_Form__c WHERE Form_Group__c like '" + this.key + "%' ORDER BY Form_Group__c LIMIT 25"};
                }
            }
        }
    });

    app.models.LocationCollection = Force.SObjectCollection.extend({
        model: app.models.Location,
        fieldlist: ["Id", "Location_ID__c"],
        cache: function () { return app.locationCache; },
        getCriteria: function () {
            return this.key;
        },
        setCriteria: function (key) {
            this.key = key;
        },
        config: function () {
            if (!app.offlineTracker.get("isOnline")) {
                return {type:"cache", cacheQuery: {queryType:"smart", smartSql: "SELECT {location__c:_soup} FROM {location__c} WHERE {location__c:Location_ID__c} LIKE '" + (this.key == null ? "" : this.key) + "%' ORDER BY {location_c:Location_ID__c}", pageSize: 25}};
            } else {
                if (this.key == null) {
                    return {type:"soql", query: "SELECT " + this.fieldlist.join(",") + " FROM Location__c WHERE Location_ID__c LIKE '%" + new Date().getFullYear() + "' ORDER BY Location_ID__c"};
                } else {
                    return {type:"soql", query: "SELECT " + this.fieldlist.join(",") + " FROM Location__c WHERE Location_ID__c LIKE '" + this.key + "%' ORDER BY Location_ID__c"};
                }
            }
        }
    });

    // Online/Offline Tracker
    app.models.OfflineTracker = Backbone.Model.extend({
        initialize: function() {
            var that = this;
            this.set("isOnline", navigator.onLine);
            document.addEventListener("offline", function() {
                console.log("Received OFFLINE event");
                that.set("isOnline", false);
            }, false);
            document.addEventListener("online", function() {
                console.log("Received ONLINE event");
                // User decides when to go back online
            }, false);
        }
    });

    // -------------------------------------------------- The Views ---------------------------------------------------- //

    app.views.SearchPage = Backbone.View.extend({

        template: _.template($("#search-page").html()),

        events: {
            "keyup .search-key": "search",
            "click .inspectSmartstore": "inspectSmartstore",
            "click .switchUser": "switchUser",
            "click .logoutUser": "logoutUser"
        },

        initialize: function() {
            this.listView = new app.views.LocationListView({model: this.model});
            this.offlineTogglerView = new app.views.OfflineToggler({model: app.offlineTracker});

            Force.forcetkClient.query("Select Id from RecordType where Name = 'Incident'", function (response) {
                app.IncidentRecordType = response.records[0].Id;
            });
            Force.forcetkClient.query("Select Id from RecordType where Name = 'Near Miss'", function (response) {
                app.NearMissRecordType = response.records[0].Id;
            });
            Force.forcetkClient.query("Select Id from RecordType where Name = 'JSA'", function (response) {
                app.JSARecordType = response.records[0].Id;
            });
            Force.forcetkClient.query("Select Id from RecordType where Name = 'LSV'", function (response) {
                app.LSVRecordType = response.records[0].Id;
            });
            Force.forcetkClient.query("Select Id from RecordType where Name = 'Safety Observation'", function (response) {
                app.SORecordType = response.records[0].Id;
            });
        },

        render: function(eventName) {
            $(this.el).html(this.template());
            $(".search-key", this.el).val(this.model.getCriteria());
            this.offlineTogglerView.setElement($("#offlineStatusPage", this.el)).render();
            this.listView.setElement($("ul", this.el)).render();
            return this;
        },

        search: function(event) {
            this.model.setCriteria($(".search-key", this.el).val());
            this.model.fetch();
        },

        inspectSmartstore: function(event) {
            cordova.require("com.salesforce.plugin.smartstore").showInspector();
        },

        switchUser: function(event) {
            cordova.require("com.salesforce.plugin.sfaccountmanager").switchToUser();
        },

        logoutUser: function(event) {
            cordova.require("com.salesforce.plugin.sfaccountmanager").logout();
        }
    });

    app.views.ActivityFormListView = Backbone.View.extend({

        listItemViews: [],

        initialize: function() {
            this.model.on("reset", this.render, this);
        },

        render: function(eventName) {
            _.each(this.listItemViews, function(itemView) { itemView.close(); });
            this.listItemViews = _.map(this.model.models, function(model) { return new app.views.ActivityFormListItemView({model: model}); });
            $(this.el).append(_.map(this.listItemViews, function(itemView) { return itemView.render().el;} ));
            return this;
        }
    });

    app.views.LocationListView = Backbone.View.extend({
        listItemViews: [],

        initialize: function () {
            this.model.on("reset", this.render, this);
        },

        render: function (eventName) {
            _.each(this.listItemViews, function(itemView) {itemView.close();});
            this.listItemViews = _.map(this.model.models, function(model) { return new app.views.LocationListItemView({model: model}); });
            $(this.el).append(_.map(this.listItemViews, function(itemView) {return itemView.render().el;}));
            return this;
        }
    });

    app.views.ActivityFormListItemView = Backbone.View.extend({

        tagName: "li",
        template: _.template($("#form-list-item").html()),

        render: function(eventName) {
            var templateData = _.extend({__sync_failed__:false}, this.model.toJSON());
            $(this.el).html(this.template(templateData));
            return this;
        },

        close: function() {
            this.remove();
            this.off();
        }
    });

    app.views.LocationListItemView = Backbone.View.extend({
        tagName: "li",
        template: _.template($("#location-list-item").html()),
        render: function (eventName) {
            var templateData = _.extend({__sync_failed__:false}, this.model.toJSON());
            $(this.el).html(this.template(templateData));
            return this;
        },
        close: function () {
            this.remove();
            this.off();
        }
    });

    app.views.OfflineToggler = Backbone.View.extend({

        template: _.template($("#offline-toggler").html()),

        events: {
            "click": "toggle"
        },

        initialize: function() {
            this.model.on("change:isOnline", this.render, this);
        },

        render: function(eventName) {
            $(this.el).html(this.template(this.model.toJSON()));
            return this;
        },

        toggle: function(event) {
            event.preventDefault();
            this.model.set("isOnline", !this.model.get("isOnline"));
            if (this.model.get("isOnline")) {
                app.router.navigate("#sync", {trigger:true});
            }
        }
    });

    app.views.SyncPage = Backbone.View.extend({

        template: _.template($("#sync-page").html()),

        events: {
            "click .back": "goBack",
            "click .sync": "sync"
        },

        initialize: function() {
            var that = this;
            _.each(["reset","add","remove"], function(eventName) { that.model.on(eventName, that.render, that); });
            this.listView = new app.views.ActivityFormListView({model: this.model});
        },

        render: function(eventName) {
            $(this.el).html(this.template(_.extend({countLocallyModified: this.model.length}, this.model.toJSON())));
            this.listView.setElement($("ul", this.el)).render();
            return this;
        },

        goBack: function(event) {
            if (this.model.length > 0) {
                // We are not done - going back offline before leaving screen
                app.offlineTracker.set("isOnline", false);
            }
            app.router.navigate("#", {trigger:true});
        },

        sync: function(event) {
            var that = this;
            if (this.model.length == 0 || this.model.at(0).get("__sync_failed__")) {
                // we push sync failures back to the end of the list - if we encounter one, it means we are done
                return;
            }
            else {
                var record = this.model.shift();

                var options = {
                    mergeMode: Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED,
                    success: function() {
                        if (that.model.length == 0) {
                            app.router.navigate("#", {trigger:true});
                        }
                        else {
                            that.sync();
                        }
                    },
                    error: function() {
                        record = record.set("__sync_failed__", true);
                        that.model.push(record);
                        that.sync();
                    }
                };

                return record.get("__locally_deleted__") ? record.destroy(options) : record.save(null, options);
            }
        }
    });

    app.views.EditActivityFormPage = Backbone.View.extend({

        action: null,
        backAction: "#",

        template: _.template($("#edit-form-page").html()),

        events: {
            "click .back": "goBack",
            "change": "change",
            "click .save": "save",
            "click .merge": "saveMerge",
            "click .overwrite": "saveOverwrite",
            "click .toggleDelete": "toggleDelete"
        },

        initialize: function() {
            this.offlineTogglerView = new app.views.OfflineToggler({model: app.offlineTracker});
            app.offlineTracker.on("change:isOnline", this.render, this);
        },

        render: function(eventName) {
            this.action = (null == this.model.id) ? "Add" : "Edit";
            if (this.action == "Add") { this.model.set({__local__: false, 'RecordTypeId': app.IncidentRecordType, Form_Group__c:"Incident", Job__c:"", Specific_Job_Type__c:"", Task__c:"", Incident_Description__c: "", Consequence__c:"", Equipment_in_use__c:"", Incident_Date_Time__c:currentDateTime(), Inc__c:"", LastModfiedBy:"", LastModifiedDate:"", attributes : { type: "Activity_Form__c"}}); }
            this.backAction = "#";
            $(this.el).html(this.template(_.extend({action: this.action}, this.model.toJSON())));
            this.offlineTogglerView.setElement($("#offlineStatusPage", this.el)).render();
            var online = app.offlineTracker.get("isOnline");
            $(".merge", this.el).hide();
            $(".overwrite", this.el).hide();

            if (this.action == "Add") {
                $(".toggleDelete", this.el).hide();
            }
            else {
                var deleted = this.model.get("__locally_deleted__");
                $(".toggleDelete", this.el).html(deleted?"Undelete":"Delete");
            }
            return this;
        },

        change: function(evt) {
            // apply change to model
            var target = evt.target;
            var type = target.type;
            var value = target.value;
            if (type === "datetime-local") {
                value = formatDateTime(target.value);
            }
            this.model.set(target.name, value);
            $("#form" + target.name + "Error", this.el).hide();
        },

        goBack: function(event) {
            if (this.backAction) {
                app.router.navigate(this.backAction, {trigger:true});
            } else {
                app.router.navigate("#", {trigger:true});
            }
        },

        showFieldError: function(field, message, error) {
            var errorEl = $("#form" + field + "Error", this.el);
            errorEl.addClass(error ? "badge badge-negative" : "count-other");
            errorEl.html(message);
            errorEl.show();
        },

        handleError: function(error) {
            var that = this;
            if (error.type === "RestError") {
                _.each(error.details, function(detail) {
                    if (detail.fields == null || detail.fields.length == 0) { alert(detail.message); }
                    else {_.each(detail.fields, function(field) {that.showFieldError(field, detail.message);});}
                });
            }
            else if (error.type == "ConflictError") {
                _.each(error.remoteChanges, function(field) {
                    var conflict = error.conflictingChanges.indexOf(field) >=0;
                    that.showFieldError(field, "Server: " +  error.theirs[field], conflict);
                });
                $(".merge", this.el).show();
                $(".overwrite", this.el).show();
            }
        },

        getSaveOptions: function(mergeMode, cacheMode) {
            var that = this;
            return {
                cacheMode: cacheMode,
                mergeMode: mergeMode,
                success: function() { app.router.navigate(that.backAction, {trigger:true}); },
                error: function(data, err, options) { that.handleError(new Force.Error(err)); }
            };
        },

        save: function() {
            this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.MERGE_FAIL_IF_CHANGED));
        },

        saveMerge: function() {
            this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.MERGE_ACCEPT_YOURS));
        },

        saveOverwrite: function() {
            this.model.save(null, this.getSaveOptions(Force.MERGE_MODE.OVERWRITE));
        },

        toggleDelete: function() {
            if (this.model.get("__locally_deleted__")) {
                this.model.set("__locally_deleted__", false);
                this.model.save(null, this.getSaveOptions(null, Force.CACHE_MODE.CACHE_ONLY));
            }
            else {
                this.model.destroy({
                    success: function(data) {
                        app.router.navigate("#", {trigger:true});
                    },
                    error: function(data, err, options) {
                        var error = new Force.Error(err);
                        alert("Failed to delete form: " + (error.type === "RestError" ? error.details[0].message : "Remote change detected - delete aborted"));
                    }
                });
            }
        }
    });


    // ----------------------------------------------- The Application Router ------------------------------------------ //

    app.Router = Backbone.StackRouter.extend({

        routes: {
            "": "list",
            "list": "list",
            "add/form/:id/:fromServer": "addForm",
            "edit/forms/:id/:fromServer": "editActivityForm",
            "sync":"sync"
        },

        setupCaches: function() {
            // Cache for offline support
            app.cache = new Force.StoreCache("activity_form__c", [ {path:"RecordTypeId", type:"string"}, {path:"LastModifiedBy.Name", type:"string"}, {path: "LastModifiedDate", type:"string"} ]);
            app.locationCache = new Force.StoreCache("location__c", [ {path: "Location_ID__c", type:"string"} ]);

            // Cache for conflict detection
            app.cacheForOriginals = new Force.StoreCache("original-activity_forms");

            return $.when(app.cache.init(), app.locationCache.init(), app.cacheForOriginals.init());
        },

        initialize: function() {
            Backbone.Router.prototype.initialize.call(this);

            // Setup caches
            this.setupCaches();

            // Collection behind search screen
            app.searchResults = new app.models.LocationCollection();

            // Collection behind sync screen
            app.localActivityForms = new app.models.ActivityFormCollection();
            app.localActivityForms.config = {type:"cache", cacheQuery: {queryType:"exact", indexPath:"__local__", matchKey:true, order:"ascending", pageSize:25}};
            app.localLocations = new app.models.LocationCollection();
            app.localLocations.config = {type: "cache", cacheQuery: {queryType:"exact", indexPath:"__local__", matchKey:true, order:"ascending", pageSize:25}};

            // Initializing offline tracker
            app.offlineTracker = new app.models.OfflineTracker({isOnline: true});

            // We keep a single instance of SearchPage / SyncPage and EditAccountPage
            app.searchPage = new app.views.SearchPage({model: app.searchResults});
            app.syncPage = new app.views.SyncPage({model: app.localActivityForms});
            app.editPage = new app.views.EditActivityFormPage();
        },

        list: function() {
            app.searchResults.fetch();
            // Show page right away - list will redraw when data comes in
            this.slidePage(app.searchPage);
        },

        // TODO: route location 'edit' to this, with location ID; remove 'create' button
        addForm: function(id) {
            app.editPage.model = new app.models.ActivityForm({Id: null, Location__c:id});
            this.slidePage(app.editPage);
        },

        editActivityForm: function(id, fromServer) {
            var that = this;
            var form = new app.models.ActivityForm({Id: id});
            var cacheMode = fromServer === "true" ? Force.CACHE_MODE.SERVER_FIRST : form.cacheMode("read");
            form.fetch({
                success: function(data) {
                    app.editPage.model = form;
                    that.slidePage(app.editPage);
                },
                error: function() {
                    alert("Failed to get record for edit");
                },
                cacheMode: cacheMode
            });
        },

        sync: function() {
            app.localActivityForms.fetch();
            // Show page right away - list will redraw when data comes in
            this.slidePage(app.syncPage);
        }
    });
</script>
</body>
</html>
